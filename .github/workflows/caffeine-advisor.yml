name: ‚òï Advanced Caffeine Advisor

on:
  push:
    branches: [main, develop]
  schedule:
    - cron: '0 9 * * 1-5'  # Weekday mornings

permissions:
  contents: read
  issues: write

jobs:
  caffeine-analysis:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Install dependencies
        run: npm install --prefer-offline 2>/dev/null || true

      - name: Debug git history
        run: |
          echo "=== GIT LOG DEBUG ==="
          echo "Current time: $(date)"
          echo "Last 10 commits:"
          git log --oneline -10
          echo ""
          echo "Commits in last 24 hours:"
          git log --since="24 hours ago" --oneline
          echo ""
          echo "All commits with numstat (last 5):"
          git log --numstat -5

      - name: Calculate caffeine prescription
        run: |
          cat > caffeine-calc.js << 'EOF'
          const { execSync } = require('child_process');

          // ============================================
          // STEP 1: CALCULATE DEVELOPER ENERGY LEVEL
          // ============================================

          function getCommitMetrics() {
            try {
              const commits24h = execSync('git log --since="24 hours ago" --oneline 2>/dev/null | wc -l').toString().trim();
              const commits7d = execSync('git log --since="7 days ago" --oneline 2>/dev/null | wc -l').toString().trim();
              const commits30d = execSync('git log --since="30 days ago" --oneline 2>/dev/null | wc -l').toString().trim();
              
              return {
                commits24h: parseInt(commits24h) || 0,
                commits7d: parseInt(commits7d) || 0,
                commits30d: parseInt(commits30d) || 0
              };
            } catch (e) {
              return { commits24h: 0, commits7d: 0, commits30d: 0 };
            }
          }

          function getCodeMetrics() {
            try {
              console.error('DEBUG: Getting code metrics with JavaScript parsing...');
              
              // Parse git numstat output in JavaScript instead of awk
              function calculateLOC(gitLogOutput) {
                let totalLOC = 0;
                const lines = gitLogOutput.split('\n').filter(l => l.trim());
                
                for (const line of lines) {
                  // numstat format: additions<tab>deletions<tab>filename
                  const parts = line.split('\t');
                  if (parts.length >= 2) {
                    const additions = parseInt(parts[0]) || 0;
                    const deletions = parseInt(parts[1]) || 0;
                    // Count net changes (additions - deletions)
                    totalLOC += Math.abs(additions - deletions);
                  }
                }
                return totalLOC;
              }
              
              // Get commits from last 24 hours
              let raw24h = '';
              try {
                raw24h = execSync(`git log --since="24 hours ago" --numstat --pretty=""`, { encoding: 'utf-8' }).toString();
              } catch (e) {
                raw24h = '';
              }
              
              let locToday = calculateLOC(raw24h);
              
              // Fallback: if no 24h data, use last 20 commits
              if (locToday === 0) {
                console.error('DEBUG: No commits in 24h window, using recent commits...');
                try {
                  raw24h = execSync(`git log -20 --numstat --pretty=""`, { encoding: 'utf-8' }).toString();
                  locToday = calculateLOC(raw24h);
                } catch (e) {
                  locToday = 0;
                }
              }
              
              console.error('DEBUG: Calculated locToday:', locToday);
              
              // Get commits from last 7 days
              let raw7d = '';
              try {
                raw7d = execSync(`git log --since="7 days ago" --numstat --pretty=""`, { encoding: 'utf-8' }).toString();
              } catch (e) {
                raw7d = '';
              }
              
              let locWeek = calculateLOC(raw7d);
              
              // Fallback: if no 7d data, use all commits
              if (locWeek === 0) {
                console.error('DEBUG: No commits in 7d window, using all commits...');
                try {
                  raw7d = execSync(`git log --numstat --pretty=""`, { encoding: 'utf-8' }).toString();
                  locWeek = calculateLOC(raw7d);
                } catch (e) {
                  locWeek = 0;
                }
              }
              
              console.error('DEBUG: Calculated locWeek:', locWeek);
              
              return {
                locToday: isNaN(locToday) || locToday < 0 ? 0 : locToday,
                locWeek: isNaN(locWeek) || locWeek < 0 ? 0 : locWeek
              };
            } catch (e) {
              console.error('DEBUG: Error getting code metrics:', e.message);
              return { locToday: 0, locWeek: 0 };
            }
          }

          function getTestCoverage() {
            try {
              // Rough estimate - check if coverage file exists
              return 75; // Default
            } catch (e) {
              return 50;
            }
          }

          // ============================================
          // STEP 2: CALCULATE ENERGY LEVEL (0-100)
          // ============================================

          function calculateEnergyLevel(commits24h, locToday) {
            let energy = 0;
            
            // Validate inputs
            commits24h = isNaN(commits24h) ? 0 : commits24h;
            locToday = isNaN(locToday) ? 0 : locToday;
            
            // Energy from commits (max 40 points)
            energy += Math.min(commits24h * 4, 40);
            
            // Energy from code output (max 40 points)
            energy += Math.min(locToday / 50, 40);
            
            // Rest factor (max 20 points) - assumes normal sleep
            energy += 20;
            
            return Math.min(Math.max(energy, 0), 100);
          }

          // ============================================
          // STEP 3: CALCULATE CAFFEINE NEEDS
          // ============================================

          function calculateCaffeinNeeds(energy, commits24h, locToday, commits7d) {
            let baseCaffeine = 0;

            // Low energy = needs MORE caffeine to compensate
            if (energy < 30) {
              baseCaffeine = 300; // Heavy dose
            } else if (energy < 50) {
              baseCaffeine = 200; // Moderate dose
            } else if (energy < 70) {
              baseCaffeine = 100; // Light dose
            } else {
              baseCaffeine = 50; // Minimal
            }

            // Add caffeine based on lines of code
            const locBonus = Math.min(locToday / 100, 50);
            
            // Add caffeine based on burnout risk (high commit rate 7d)
            const burnoutRisk = commits7d > 70 ? 75 : commits7d > 40 ? 25 : 0;

            const totalCaffeine = baseCaffeine + locBonus + burnoutRisk;

            return {
              baseCaffeine,
              locBonus,
              burnoutRisk,
              totalCaffeine: Math.round(totalCaffeine)
            };
          }

          // ============================================
          // STEP 4: CAFFEINE PRODUCT DATABASE
          // ============================================

          const caffeinProducts = {
            espresso: { mg: 63, serving: "1 shot (1 oz)", emoji: "‚òï", cost: "$2.50" },
            americano: { mg: 150, serving: "1 cup (12 oz)", emoji: "‚òï", cost: "$3.50" },
            latte: { mg: 75, serving: "1 cup (12 oz)", emoji: "ü•õ", cost: "$4.00" },
            cappuccino: { mg: 75, serving: "1 cup (12 oz)", emoji: "ü•õ", cost: "$4.00" },
            drip_coffee: { mg: 95, serving: "1 cup (8 oz)", emoji: "‚òï", cost: "$1.50" },
            french_press: { mg: 80, serving: "1 cup (8 oz)", emoji: "‚òï", cost: "$2.00" },
            black_tea: { mg: 45, serving: "1 cup (8 oz)", emoji: "üçµ", cost: "$1.00" },
            green_tea: { mg: 25, serving: "1 cup (8 oz)", emoji: "üçµ", cost: "$1.00" },
            matcha: { mg: 70, serving: "1 cup (8 oz)", emoji: "üçµ", cost: "$6.00" },
            energy_drink: { mg: 80, serving: "1 can (8.4 oz)", emoji: "‚ö°", cost: "$2.00" },
            energy_shot: { mg: 200, serving: "1 shot (2 oz)", emoji: "üíâ", cost: "$3.00" },
            chocolate: { mg: 12, serving: "1 oz square", emoji: "üç´", cost: "$1.00" },
            diet_coke: { mg: 46, serving: "1 can (12 oz)", emoji: "ü•§", cost: "$1.50" },
            mountain_dew: { mg: 54, serving: "1 can (12 oz)", emoji: "ü•§", cost: "$1.50" },
            cola: { mg: 34, serving: "1 can (12 oz)", emoji: "ü•§", cost: "$1.50" },
            cold_brew: { mg: 150, serving: "1 cup (8 oz)", emoji: "üßä‚òï", cost: "$4.00" },
            espresso_martini: { mg: 126, serving: "1 cocktail (2 oz)", emoji: "üçπ", cost: "$8.00" },
            iced_latte: { mg: 75, serving: "1 cup (12 oz)", emoji: "üßä", cost: "$4.50" },
            nitro_cold_brew: { mg: 280, serving: "1 cup (8 oz)", emoji: "üßä‚òïüí™", cost: "$5.00" }
          };

          // ============================================
          // STEP 5: GENERATE RECOMMENDATIONS
          // ============================================

          function getRecommendations(caffeineMg) {
            const recommendations = [];
            let remainingCaffeine = caffeineMg;

            // Smart algorithm: prioritize efficient options
            const prioritized = [
              'nitro_cold_brew', 'energy_shot', 'cold_brew', 'americano', 
              'espresso', 'matcha', 'energy_drink', 'black_tea', 'drip_coffee'
            ];

            for (const product of prioritized) {
              if (remainingCaffeine <= 0) break;
              
              const item = caffeinProducts[product];
              const servings = Math.ceil(remainingCaffeine / item.mg);
              
              if (servings > 0) {
                recommendations.push({
                  product,
                  servings,
                  totalMg: servings * item.mg,
                  serving: item.serving,
                  emoji: item.emoji,
                  cost: item.cost
                });
                
                remainingCaffeine -= servings * item.mg;
              }
            }

            return recommendations;
          }

          // ============================================
          // STEP 6: HEALTH & SAFETY WARNINGS
          // ============================================

          function getHealthWarning(caffeineMg) {
            if (caffeineMg < 50) {
              return "‚úÖ SAFE - No concerns. Normal caffeine intake.";
            } else if (caffeineMg < 200) {
              return "üü° MODERATE - Keep an eye on this. Don't overdo it.";
            } else if (caffeineMg < 400) {
              return "üü† ELEVATED - Getting close to max daily recommendation (400mg).";
            } else if (caffeineMg < 600) {
              return "üî¥ HIGH - Exceeding recommended daily intake. You might experience jitters.";
            } else {
              return "üíÄ DANGER - EXTREME caffeine intake. This is NOT recommended. SLEEP instead.";
            }
          }

          function getEnergySuggestion(energy) {
            if (energy < 20) {
              return "üö® CRITICAL: You need REST more than caffeine. Go to bed NOW.";
            } else if (energy < 40) {
              return "üò¥ VERY LOW: Consider a 20-minute nap before the caffeine.";
            } else if (energy < 60) {
              return "üòë LOW: Caffeine + walk + water will help.";
            } else if (energy < 80) {
              return "‚úÖ GOOD: Light caffeine should keep you productive.";
            } else {
              return "üî• SUPERCHARGED: You might not even need caffeine! Stay hydrated.";
            }
          }

          function getBurnoutStatus(commits7d) {
            const avgPerDay = commits7d / 7;
            
            if (commits7d < 20) {
              return "üü¢ HEALTHY - Nice work-life balance.";
            } else if (commits7d < 40) {
              return "üü° GOOD - Solid pace, sustainable.";
            } else if (commits7d < 70) {
              return "üü† ELEVATED - You're working hard. Watch for burnout.";
            } else {
              return "üî¥ BURNOUT RISK - You're pushing too hard. Slow down!";
            }
          }

          // ============================================
          // MAIN CALCULATION
          // ============================================

          const commits = getCommitMetrics();
          const code = getCodeMetrics();
          const coverage = getTestCoverage();

          const energy = calculateEnergyLevel(commits.commits24h, code.locToday);
          const caffeine = calculateCaffeinNeeds(energy, commits.commits24h, code.locToday, commits.commits7d);
          const recommendations = getRecommendations(caffeine.totalCaffeine);
          const warning = getHealthWarning(caffeine.totalCaffeine);
          const energySuggestion = getEnergySuggestion(energy);
          const burnoutStatus = getBurnoutStatus(commits.commits7d);

          // ============================================
          // OUTPUT RESULTS
          // ============================================

          console.log(JSON.stringify({
            energy: Math.round(energy),
            caffeineMg: caffeine.totalCaffeine,
            commits24h: commits.commits24h,
            commits7d: commits.commits7d,
            commits30d: commits.commits30d,
            locToday: code.locToday,
            locWeek: code.locWeek,
            caffeineMgBreakdown: {
              base: caffeine.baseCaffeine,
              locBonus: Math.round(caffeine.locBonus),
              burnoutRisk: caffeine.burnoutRisk
            },
            recommendations: recommendations.map(r => ({
              product: r.product,
              servings: r.servings,
              totalMg: r.totalMg,
              serving: r.serving,
              emoji: r.emoji,
              cost: r.cost
            })),
            warnings: {
              healthStatus: warning,
              energyLevel: energySuggestion,
              burnoutStatus: burnoutStatus
            }
          }, null, 2));

          EOF

          node caffeine-calc.js > caffeine-report.json
          cat caffeine-report.json
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create GitHub issue with recommendations
        run: |
          cat > create-issue.js << 'EOF'
          const fs = require('fs');
          const { execSync } = require('child_process');

          const data = JSON.parse(fs.readFileSync('caffeine-report.json', 'utf8'));

          // Build markdown report
          let markdown = `# ‚òï Advanced Caffeine Prescription Report

          ## üìä Energy Analysis

          **Current Energy Level:** \`${data.energy}/100\`

          ${data.energy >= 80 ? 'üî•' : data.energy >= 60 ? 'üü¢' : data.energy >= 40 ? 'üü°' : 'üî¥'} **Status:** 
          ${data.energy < 30 ? 'CRITICAL - You are running on empty' : 
            data.energy < 50 ? 'LOW - Needs attention' : 
            data.energy < 70 ? 'MODERATE - Getting tired' :
            data.energy < 85 ? 'GOOD - Stable' : 'EXCELLENT - You are thriving'}

          ## üö¶ Development Metrics (Last 24 Hours)

          | Metric | Value |
          |--------|-------|
          | **Commits** | ${data.commits24h} |
          | **Lines Changed** | ${data.locToday} |
          | **Energy Level** | ${data.energy}/100 |
          | **Avg Lines/Commit** | ${data.locToday > 0 ? Math.round(data.locToday / Math.max(data.commits24h, 1)) : 0} |

          ## üìà Weekly Activity

          | Metric | Value |
          |--------|-------|
          | **7-Day Commits** | ${data.commits7d} |
          | **30-Day Commits** | ${data.commits30d} |
          | **Avg Commits/Day (7d)** | ${Math.round(data.commits7d / 7)} |
          | **Lines Added (Week)** | ${data.locWeek} |

          ## ‚òï Caffeine Prescription

          **Total Recommended Caffeine:** \`${data.caffeineMg}mg\`

          ### Breakdown:
          - **Base Metabolic Need:** ${data.caffeineMgBreakdown.base}mg
          - **Code Output Bonus:** +${data.caffeineMgBreakdown.locBonus}mg
          - **Burnout Risk Factor:** +${data.caffeineMgBreakdown.burnoutRisk}mg

          ---

          ## üíä Product Recommendations

          ${data.recommendations.length === 0 ? '**No caffeine needed!** Go drink some water and take a walk.' : 
            data.recommendations.map((r, i) => `
          ### Option ${i + 1}: ${r.emoji} ${r.product.replace(/_/g, ' ').toUpperCase()}
          - **Quantity:** ${r.servings} ${r.serving}
          - **Total Caffeine:** ${r.totalMg}mg
          - **Est. Cost:** ${r.cost}
          - **Ratio:** ${Math.round(r.totalMg / r.servings)}mg per serving
          `).join('\n')}

          ---

          ## ‚ö†Ô∏è Health & Safety Status

          ${data.warnings.healthStatus}

          ${data.warnings.energyLevel}

          ${data.warnings.burnoutStatus}

          ---

          ## üéØ Personalized Recommendations

          ${data.energy < 30 ? 
            '### YOU NEED TO SLEEP üò¥\nSeriously, caffeine won\'t help at this point. Go get 8 hours of sleep. We\'ll be here.' :
            data.energy < 50 ?
            '### Coffee Break Required ‚òï\nTake a 20-minute nap, stretch, drink water, THEN have caffeine. Your body is exhausted.' :
            data.energy < 70 ?
            '### Moderate Boost Recommended\nA single espresso or cup of tea should get you through the next 4 hours.' :
            data.energy < 85 ?
            '### Light Caffeine Optional\nYou\'re doing well! Light caffeine can help maintain momentum.' :
            '### You Don\'t Need Caffeine\nYou\'re already crushing it! Stay hydrated and keep the momentum going.'}

          ${data.commits7d > 70 ? 
            '\n\n### ‚ö†Ô∏è BURNOUT ALERT\nYou\'ve averaged ' + Math.round(data.commits7d / 7) + ' commits per day this week. Consider:\n- Taking a day off\n- Working shorter hours\n- Saying "no" to new tasks\n- Talking to your team about workload' : ''}

          ---

          ## üìã Quick Reference Table

          | Scenario | What to Drink | Amount |
          |----------|---------------|--------|
          | **Quick Boost** | Espresso | 1-2 shots |
          | **Sustained Energy** | Cold Brew | 1 cup |
          | **Afternoon Pick-up** | Black Tea | 1 cup |
          | **All-Nighter** | Energy Shot | 1 bottle |
          | **Healthy Option** | Matcha Latte | 1 cup |
          | **Just Say No** | Water | 2+ cups |

          ---

          **Report Generated:** ${new Date().toLocaleString()}
          `;

          // Execute gh cli
          fs.writeFileSync('caffeine-report.md', markdown);
          
          const title = `‚òï Caffeine Prescription for ${process.env.GITHUB_ACTOR}`;
          const cmd = `gh issue create --title "${title}" --body-file caffeine-report.md`;
          
          console.error('Attempting to create issue with gh cli...');
          console.error('Title:', title);
          console.error('GH_TOKEN set:', !!process.env.GH_TOKEN);
          console.error('GITHUB_ACTOR:', process.env.GITHUB_ACTOR);
          
          try {
            const result = execSync(cmd, { encoding: 'utf-8' });
            console.error('‚úÖ Issue created successfully');
            console.error('Result:', result);
          } catch (e) {
            console.error('‚ùå Error creating issue:');
            console.error('Command:', cmd);
            console.error('Error:', e.message);
            console.error('Stderr:', e.stderr ? e.stderr.toString() : 'N/A');
            console.error('But report was still generated in caffeine-report.md');
          }

          EOF

          node create-issue.js
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_ACTOR: ${{ github.actor }}

      - name: Display report in console
        if: always()
        run: |
          echo "üìä CAFFEINE PRESCRIPTION REPORT"
          echo "=============================="
          cat caffeine-report.json | jq '.'
